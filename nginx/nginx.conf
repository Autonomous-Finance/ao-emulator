worker_processes auto;

events { worker_connections 1024; }

http {
    resolver 127.0.0.11 valid=30s;
    resolver_timeout 10s;

    # Extract process-id from the raw query string
    map $query_string $real_process_id {
        "~(?:^|&)process-id=([^&]+)"   $1;
        default                       "";
    }

    # Map each process-id to the complete proxy URI
    # Configure your process IDs here
    map $real_process_id $proxy_target {
        # Example:
        # "YOUR_PROCESS_ID"  "http://aos_example_service/dry-run";
        
        default "";
    }

    # Define upstreams here matching your docker-compose services
    # upstream aos_example_service { server aos-example-service:8080; }

    server {
        listen 80;
        server_name localhost;

        location /health {
            return 200 'OK';
        }

        location /dry-run {
            add_header X-Debug-Process-ID $real_process_id;
            
            if ($proxy_target = "") {
                return 404;
            }

            proxy_pass $proxy_target$is_args$args;
            
            proxy_set_header Host          $host;
            proxy_set_header X-Real-IP     $remote_addr;
            proxy_set_header X-Process-ID  $real_process_id;
            proxy_ssl_server_name on;
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html { root /usr/share/nginx/html; }
    }
}
