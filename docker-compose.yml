version: '3.8'

x-service-base: &service-base
  build: .
  expose: [ "8080" ]
  networks: [ aos-network ]
  healthcheck:
    test: [ "CMD-SHELL", "curl --fail --silent --max-time 10 http://localhost:8080/health || exit 1" ]
    interval: 30s
    timeout: 10s
    retries: 5
    start_period: 300s

x-env-base: &env-base
  SU_URL: https://su-router.ao-testnet.xyz
  MESSAGE_POLLING_INTERVAL: 10s
  PORT: 8080

services:
  traefik:
    image: traefik:v3.4
    command:
      - --log.level=INFO
      - --providers.docker=true
      - --providers.docker.exposedByDefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.metrics.address=:9100
      - --api.dashboard=true
      - --api.debug=true
      - --accesslog=true
      - --accesslog.format=json
      - --metrics.prometheus=true
      - --metrics.prometheus.entrypoint=metrics
      - --metrics.prometheus.addrouterslabels=true
      - --metrics.prometheus.addserviceslabels=true
    ports:
      - "8080:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - traefik.enable=true
      - traefik.http.routers.dashboard.rule=Host(`traefik.localhost`)
      - traefik.http.routers.dashboard.service=api@internal
    networks: [ aos-network ]

  # Example Service Configuration
  # aos-example-process:
  #   <<: *service-base
  #   environment:
  #     <<: *env-base
  #     PROCESS_ID_TO_MONITOR: YOUR_PROCESS_ID_HERE
  #   labels:
  #     - traefik.enable=true
  #     - traefik.http.routers.example.rule=Query(`process-id`,`YOUR_PROCESS_ID_HERE`)
  #     - traefik.http.routers.example.entrypoints=web
  #     - traefik.http.services.example.loadbalancer.server.port=8080

  # Monitoring Stack
  prometheus:
    image: prom/prometheus
    command:
      - --config.file=/etc/prometheus/prometheus.yml
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports: [ "9090:9090" ]
    networks: [ aos-network ]

  grafana:
    image: grafana/grafana:11.0.0
    ports: [ "3005:3000" ]
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_INSTALL_PLUGINS: grafana-piechart-panel
    volumes:
      - ./grafana/datasources:/etc/grafana/provisioning/datasources:ro
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
    networks: [ aos-network ]

  node-exporter:
    image: prom/node-exporter
    pid: host
    volumes: [ /proc:/host/proc:ro, /sys:/host/sys:ro ]
    command: [ "--path.rootfs=/host" ]
    networks: [ aos-network ]

  docker-exporter:
    image: prometheusnet/docker_exporter:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports: [ "9417:9417" ]
    networks: [ aos-network ]

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    privileged: true
    command:
      - --housekeeping_interval=10s
      - --port=8081
      - --docker_only=true
      - --store_container_labels=true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    ports: [ "8081:8081" ]
    networks: [ aos-network ]

networks: { aos-network: {} }
