version: '3.8'

x-service-base: &service-base
  build: .
  expose: ["8080"]
  networks: [aos-network]

x-env-base: &env-base
  SU_URL: https://su-router.ao-testnet.xyz
  MESSAGE_POLLING_INTERVAL: 10s
  PORT: 8080

services:
  traefik:
    image: traefik:v3.4
    command:
      # ────────── core ──────────
      - --log.level=INFO              # keep DEBUG for trouble-shooting only
      - --providers.docker=true
      - --providers.docker.exposedByDefault=false

      # ────────── entry-points ─────
      - --entrypoints.web.address=:80
      - --entrypoints.metrics.address=:9100   # ← Prometheus will scrape here

      # ────────── dashboard / api ─
      - --api.dashboard=true
      - --api.debug=true                    # adds /api/rawdata

      # ────────── ACCESS LOG ───────
      - --accesslog=true                    # turn it on :contentReference[oaicite:0]{index=0}
      - --accesslog.format=json             # easier to ship to Loki/ELK
      - --accesslog.addinternals=true       # include dashboard, ping, etc.

      # ────────── METRICS (Prom) ───
      - --metrics.prometheus=true           # exporter on the chosen EP :contentReference[oaicite:1]{index=1}
      - --metrics.prometheus.entrypoint=metrics
      - --metrics.prometheus.addrouterslabels=true
      - --metrics.prometheus.addserviceslabels=true
    ports:
      - "80:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
    - traefik.enable=true
    - traefik.http.routers.tkd.rule=Host(`traefik.localhost`)
    - traefik.http.routers.tkd.entrypoints=web           # or websecure
    - traefik.http.routers.tkd.service=api@internal
    networks: [aos-network]

  # Agent Factory Process
  aos-agent-factory:
    <<: *service-base
    deploy:
      replicas: 1
    environment:
      <<: *env-base
      PROCESS_ID_TO_MONITOR: x_WysdFwKD_buywRK9qLA7IexdlsvVTVq6ESWMRCzFY
    labels:
      - traefik.enable=true
      - traefik.http.routers.agent.rule=Query(`process-id=x_WysdFwKD_buywRK9qLA7IexdlsvVTVq6ESWMRCzFY`)
      - traefik.http.routers.agent.entrypoints=web
      - traefik.http.services.agent.loadbalancer.server.port=8080

  # Permaweb Index Process
  # aos-permaweb-index:
  #   build: .
  #   environment:
  #     - PROCESS_ID_TO_MONITOR=rxxU4g-7tUHGvF28W2l53hxarpbaFR4NaSnOaxx6MIE
  #     - PORT=3002
  #     - SU_URL=https://su-router.ao-testnet.xyz
  #     - MESSAGE_POLLING_INTERVAL=10s
  #   networks:
  #     - aos-network

  # Dexi Process
  aos-dexi:
    <<: *service-base
    deploy:
      replicas: 4
    environment:
      <<: *env-base
      PROCESS_ID_TO_MONITOR: Meb6GwY5I9QN77F0c5Ku2GpCFxtYyG1mfJus2GWYtII
    labels:
      - traefik.enable=true
      - traefik.http.routers.dexi.rule=Query(`process-id=Meb6GwY5I9QN77F0c5Ku2GpCFxtYyG1mfJus2GWYtII`)
      - traefik.http.routers.dexi.entrypoints=web
      - traefik.http.services.dexi.loadbalancer.server.port=8080
      # fallback:
      - traefik.http.routers.dexi-default.rule=PathPrefix(`/`)
      - traefik.http.routers.dexi-default.priority=1


  # Token Locker Process
  # aos-token-locker:
  #   build: .
  #   environment:
  #     - PROCESS_ID_TO_MONITOR=jxiKuu_21_KjNga8KxH1h8fJeoCl9DzcEjGBiKN66DY
  #     - PORT=3005
  #     - SU_URL=https://su-router.ao-testnet.xyz
  #     - MESSAGE_POLLING_INTERVAL=10s
  #   networks:
  #     - aos-network

  # Permaweb Index Token Process
  # aos-permaweb-index-token:
  #   build: .
  #   environment:
  #     - PROCESS_ID_TO_MONITOR=4hXj_E-5fAKmo4E8KjgQvuDJKAFk9P2grhycVmISDLs
  #     - PORT=3006
  #     - SU_URL=https://su-router.ao-testnet.xyz
  #     - MESSAGE_POLLING_INTERVAL=10s
  #   networks:
  #     - aos-network

  # Registry Process
  # aos-registry:
  #   build: .
  #   environment:
  #     - PROCESS_ID_TO_MONITOR=iZuNCnURIQHazG9cIui2B5FdQzWRE8TMa28i6nHr5ic
  #     - PORT=3007
  #     - SU_URL=https://su-router.ao-testnet.xyz
  #     - MESSAGE_POLLING_INTERVAL=10s
  #   networks:
  #     - aos-network

  # Token Factory Process
  # aos-token-factory:
  #   build: .
  #   environment:
  #     - PROCESS_ID_TO_MONITOR=mQES2_hwlXQS8JVSdPJvRTkp78slLCl2gpm6sW3CK9w
  #     - PORT=3010
  #     - SU_URL=https://su-router.ao-testnet.xyz
  #     - MESSAGE_POLLING_INTERVAL=10s
  #   networks:
  #     - aos-network

  # Portfolio Agent Factory Process
  # aos-portfolio-agent-factory:
  #   build: .
  #   environment:
  #     - PROCESS_ID_TO_MONITOR=OF3TuQgd3RkTb9HSs_V94vVPFeRXi1h0EGJhSgda7OI
  #     - PORT=3011
  #     - SU_URL=https://su-router.ao-testnet.xyz
  #     - MESSAGE_POLLING_INTERVAL=10s
  #   networks:
  #     - aos-network

  # FLP Factory Process
  # aos-flp-factory:
  #   build: .
  #   environment:
  #     - PROCESS_ID_TO_MONITOR=It-_AKlEfARBmJdbJew1nG9_hIaZt0t20wQc28mFGBE
  #     - PORT=3012
  #     - SU_URL=https://su-router.ao-testnet.xyz
  #     - MESSAGE_POLLING_INTERVAL=10s
  #   networks:
  #     - aos-network

  # AMM Factory Process
  # aos-amm-factory:
  #   build: .
  #   environment:
  #     - PROCESS_ID_TO_MONITOR=3XBGLrygs11K63F_7mldWz4veNx6Llg6hI2yZs8LKHo
  #     - PORT=3013
  #     - SU_URL=https://su-router.ao-testnet.xyz
  #     - MESSAGE_POLLING_INTERVAL=10s
  #   networks:
  #     - aos-network

  # Payment Token Process
  # aos-payment-token:
  #   build: .
  #   environment:
  #     - PROCESS_ID_TO_MONITOR=atlyT9ph8ex_TxDDkQ2fdbhVT62sLw6boJPdEr7UqJE
  #     - PORT=3014
  #     - SU_URL=https://su-router.ao-testnet.xyz
  #     - MESSAGE_POLLING_INTERVAL=10s
  #   networks:
  #     - aos-network

  # AO Process
  # aos-ao:
  #   build: .
  #   environment:
  #     - PROCESS_ID_TO_MONITOR=0syT13r0s0tgPmIed95bJnuSqaD29HQNN8D3ElLSrsc
  #     - PORT=3016
  #     - SU_URL=https://su-router.ao-testnet.xyz
  #     - MESSAGE_POLLING_INTERVAL=10s
  #   networks:
  #     - aos-network

  # nginx:
  #   image: nginx:alpine
  #   ports:
  #     - "8080:80"
  #   volumes:
  #     - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
  #   depends_on:
  #     - aos-agent-factory
  #     - aos-permaweb-index
  #     - aos-dexi
  #     - aos-token-locker
  #     - aos-permaweb-index-token
  #     - aos-registry
  #     - aos-token-factory
  #     - aos-portfolio-agent-factory
  #     - aos-flp-factory
  #     - aos-amm-factory
  #     - aos-payment-token
  #     - aos-ao
  #   networks:
  #     - aos-network

  # ─── monitoring stack ─────────────────────────────────────────────
  prometheus:
    image: prom/prometheus
    command:
      - --config.file=/etc/prometheus/prometheus.yml
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports: ["9090:9090"]
    networks: [aos-network]

  grafana:
    image: grafana/grafana:11.0.0          # latest LTS, May 2025
    ports: ["3001:3000"]                   # browse → http://localhost:3001
    environment:
      GF_SECURITY_ADMIN_USER:   admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_INSTALL_PLUGINS: grafana-piechart-panel
    volumes:
      - ./grafana/datasources:/etc/grafana/provisioning/datasources:ro
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
    networks: [aos-network]

  # node-exporter
  node-exporter:
    image: prom/node-exporter
    pid: host
    volumes: [/proc:/host/proc:ro, /sys:/host/sys:ro]
    command: ["--path.rootfs=/host"]
    networks: [aos-network]

  # Docker container metrics exporter for Prometheus
  docker-exporter:
    image: prometheusnet/docker_exporter:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports: ["9417:9417"]
    networks: [aos-network]
    
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    privileged: true                        # needed on Docker-Desktop & SELinux
    command: 
      - --housekeeping_interval=10s
      - --port=8081
      - --docker_only=true
      - --store_container_labels=true       # Enable container labels
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro   # ← gives API access
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    ports: ["8081:8081"]  # Expose cAdvisor UI
    networks: [aos-network]

networks: { aos-network: {} }
